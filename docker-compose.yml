services:
  timelapse-manager:
    #image: ghcr.io/kernelkaribou/timelapse-manager:latest
    build: .
    image: timelapse-manager:latest
    container_name: timelapse-manager
    environment:
      # Recommended: Set user and group IDs for file permissions, Defaults to Root (0)
      - PUID=1000 
      - PGID=1000
      # Recommended: Set timezone, Defaults to UTC, otherwise you will have a bad time if not in UTC
      - TZ=Etc/UTC
      # Optional environment variables:
      # - LOG_LEVEL=INFO # Logging level: DEBUG, INFO, WARNING, ERROR. Default: INFO
      # - PORT=8080 # Set custom port
      # - DATABASE_PATH=/app/data/timelapse-manager.db # Set custom database path
      # - DEFAULT_CAPTURES_PATH=/captures # Set custom captures path
      # - DEFAULT_VIDEOS_PATH=/timelapses # Set custom videos path
      # - FFMPEG_TIMEOUT=10 # Set custom ffmpeg timeout in seconds
    ports:
      - "8080:8080"
    volumes:
      - ${PWD}/captures:/captures
      - ${PWD}/timelapses:/timelapses
      - ${PWD}/data:/app/data
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '2' # Limit to 2 CPU cores, adjust as needed
          memory: 2G # Limit to 2GB RAM, adjust as needed
    # Security: Drop unnecessary capabilities
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
